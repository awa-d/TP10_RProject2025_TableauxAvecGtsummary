---
title: " "
author: ""
date: "24/03/2025"
output: html_document
---

# üìñ Chapitre I. Les principales fonctions de gtsummary et leurs param√®tres

Il existe quatre principales mani√®res de personnaliser la sortie du tableau r√©capitulatif :

- Utilisation des arguments de la fonction `tbl_summary()`

- Ajout d'informations suppl√©mentaires avec les fonctions `add_()`

- Fonctions de personnalisation du tableau

- Les th√®mes gtsummary

Et il est possible d'exporter les tableaux vers diff√©rents formats.



## 0. Pr√©ambule sur les op√©rateurs de pipe

<img src="images/pipes.jpg" width="150" style="margin-right: 20px;"> <br>

Avant d'explorer les fonctionnalit√©s de gtsummary, il est utile de comprendre les op√©rateurs pipe qui facilitent l'√©criture de code dans R :

- Op√©rateur natif |>

Introduit dans R 4.1.0 (2021), l‚Äôop√©rateur |> permet de simplifier l‚Äô√©criture des cha√Ænes de traitement. Il envoie la valeur situ√©e √† sa gauche comme premier argument √† la fonction √† sa droite. Par exemple :

```{r setup, echo=TRUE, eval=FALSE, include=TRUE}
result <- data |> head(10)
```
√©quivaut √† :
```{r, echo=TRUE, eval=FALSE, include=TRUE}
result <- head(data, 10)
```

- Pipe du tidyverse %>%

Provenant du package magrittr (et souvent utilis√© via dplyr ou tidyverse), %>% permet √©galement de cha√Æner des op√©rations. Ce pipe est particuli√®rement flexible et permet d‚Äôins√©rer des appels de fonctions de mani√®re plus naturelle. Par exemple :

```{r, echo=TRUE, eval=FALSE, include=TRUE}
library(dplyr)
result <- data %>% 
  filter(age > 30) %>% 
  summarise(mean_age = mean(age, na.rm = TRUE))
```
√©quivaut √† : 

```{r, echo=TRUE, eval=FALSE, include=TRUE}
filtered_data <- filter(data, age > 30)
result <- summarise(filtered_data, mean_age = mean(age, na.rm = TRUE))
```

Les deux pipes offrent une syntaxe fluide et lisible. La diff√©rence majeure r√©side dans la compatibilit√© avec d‚Äôautres packages et dans certaines subtilit√©s syntaxiques, mais dans la pratique, ils remplissent le m√™me r√¥le.

## 1. Utilisation des arguments de la fonction tbl_summary()

**Description :**  
`Cette fonction peut prendre, au minimum, un data frame comme seul argument d'entr√©e et renvoie, dans ce cas, des statistiques descriptives pour chaque colonne du data frame.
```{r, echo=FALSE,warning=FALSE}

# IMPORTATION
library(readr)
dataset <- read_csv("data/ehcvm_welfare_2b_bfa2021.csv")
#View(dataset)
#head(dataset)
#names(dataset)
```

```{r,eval=F, echo=T,warning=FALSE }
library(gtsummary)
dataset |> tbl_summary()
```

**Arguments cl√©s :** 

La fonction tbl_summary() propose plusieurs options pour modifier l'apparence du tableau r√©capitulatif. Voici un aper√ßu des principaux arguments :

| Argument | Description |
|---------|-------------|
| `type` |	D√©finit le type de variable (ex. : continue, cat√©gorielle, etc.)|
| `sort` |	Trie les niveaux d‚Äôune variable cat√©gorielle par fr√©quence|
| `percent` |	D√©finit si les pourcentages doivent √™tre affich√©s par colonne, ligne ou cellule|
| `by` | Permet de stratifier les statistiques selon une variable sp√©cifique (par exemple, pour comparer les groupes)|
| `label` | Personnalise les √©tiquettes affich√©es pour les variables |
| `statistic` | D√©finit les statistiques √† afficher pour chaque variable, en utilisant souvent la syntaxe {glue} (ex. : `"{mean} ({sd})"`)|
| `digits` | Sp√©cifie le nombre de d√©cimales √† utiliser pour l‚Äôaffichage des statistique|
| `missing` | Indique s‚Äôil faut afficher une ligne avec le nombre de valeurs manquantes ("ifany" : Affichage explicite des valeurs manquantes si elles existent)|
| `include` | Liste des variables √† inclure dans le tableau|

**Exemple de script :**

```{r chap1tbl_summary_examplesimple,warning=FALSE}
library(gtsummary)
tbl_summary_examplesimple <- dataset %>%
  tbl_summary(
    by = hgender,  # Stratification : les statistiques sont calcul√©es s√©par√©ment pour chaque sexe
    include = hage,  # Seule 'hage' est dans le tableau
    label = hage ~ "Age du chef de m√©nage",  
    statistic = all_continuous() ~ "{mean} ({sd})",  # Pour les variables continues, afficher la moyenne et l'√©cart-type
    digits = all_continuous() ~ 2,  # Val num avec 2 d√©cimales
    missing = "ifany"  # Affichage explicite des valeurs manquantes si elles existent
  )
# Affichage du tableau
tbl_summary_examplesimple
```
Exemple d'interpr√©tation : 

- L‚Äô√©chantillon est domin√© par des hommes, qui repr√©sentent la grande majorit√© des chefs de m√©nage (6 101 contre 1 075).
- En moyenne, les chefs de m√©nage f√©minins sont plus √¢g√©s (48 ans) que les chefs de m√©nage masculins (45 ans).
- De plus, la variabilit√© de l'√¢ge des chefs de m√©nage est l√©g√®rement plus √©lev√©e chez les femmes (15.37  contre 14.50).

Allons plus loin en incluant plusieurs variables dans notre tableau ...

```{r chap1tbl_summary_example, echo=TRUE, eval=TRUE}
# Cr√©ation d'un tableau de synth√®se stratifi√© par la variable 'hage'
tbl_summary_example <- dataset %>%
  tbl_summary(
    by = hgender,  
    include = c(hage, hhsize, hmstat, hreligion, hdiploma, hhandig),  # Toutes ces variables seront incluses dans le tableau
    label = list(
      hage ~ "√Çge du chef de m√©nage",  
      hhsize ~ "Taille du m√©nage",  
      hmstat ~ "Statut matrimonial du chef de m√©nage", 
      hreligion ~ "Religion",  
      hdiploma ~ "Plus haut dipl√¥me du chef de m√©nage", 
      hhandig ~ "Des handicap√©s dans le m√©nage ?"  
    ),  
    statistic = all_continuous() ~ "{mean} ({sd})",  
    digits = all_continuous() ~ 2,  
    missing = "ifany"  
  )

# Affichage du tableau
tbl_summary_example
```


## 2. Ajout d'informations suppl√©mentaires avec les fonctions add_()

### a. add_overall()

**Description :**  
Ajoute une colonne contenant les statistiques globales (non stratifi√©es), en compl√©ment de celles affich√©es par groupe.

**Param√®tres importants :**

- **last** : Positionne la colonne globale √† la fin du tableau (TRUE/FALSE).
- **col_label** : Permet de personnaliser l‚Äôintitul√© de la colonne globale.

**Exemple de script :**

```{r chap1tbl_summary_overall, echo=TRUE, eval=TRUE}
tbl_summary_overall <- tbl_summary_example %>%
  add_overall(
    last = TRUE,
    col_label = "**Colonne des totaux ajout√©** {N}"
  )

tbl_summary_overall
```
Exemple d'interpr√©tation : 

- L'√©chantillon total comprend 7,176 chefs de m√©nage.
- L'√¢ge moyen global est 45.68 ans tandis que l'√©cart-type global est 14.67 ans.

### b. add_n()

**Description :**  
Ajoute une colonne indiquant le nombre d‚Äôobservations (ou le nombre d‚Äôobservations non manquantes) pour chaque variable.

**Param√®tres importants :**

- **col_label** : Modifie l‚Äôintitul√© de la colonne.
- **statistic** : Permet de d√©finir le format d‚Äôaffichage des effectifs.
- **footnote** : Ajoute une note de bas de tableau explicative.

**Exemple de script :**

```{r chap1tbl_summary_with_n, echo=TRUE, eval=TRUE, include=TRUE}
tbl_summary_with_n <- tbl_summary_example %>%
  add_n(
    col_label = "**Effectif**",  # Intitul√© de la colonne
    statistic = "{N_nonmiss}",  # {p_miss}ou {N}...
  ) %>%
  modify_table_styling(
    columns = everything(),
    footnote = "Nbre d'observations non manquantes"
  )

# Afficher le tableau final
tbl_summary_with_n
```

Dans cet exemple, nous avons utilis√© uniquement les fonctions add_n() et add_overall() pour enrichir notre tableau de synth√®se. 

Cependant, il existe d'autres fonctions comme add_p() pour ajouter des p-values pour comparer les groupes, add_difference() pour calculer la diff√©rence entre deux groupes avec l'intervalle de confiance et la p-value associ√©e, ou encore add_stat_label() pour ajouter des √©tiquettes aux statistiques affich√©es. Nous n'avons pas utilis√© ces fonctions ici, car elles n√©cessitent la mise en ≈ìuvre de tests statistiques, ce que nous n'avons pas encore couvert dans le cadre de notre formation. 

## 3. Fonctions de personnalisation du tableau

Ces fonctions de formatage de table propos√©es par `gtsummary` permettent de modifier l‚Äôaspect du tableau apr√®s sa cr√©ation.

- modify_header() : Met √† jour les en-t√™tes de colonnes.

```{r chap1modifyheader, echo=TRUE, eval=TRUE, include=TRUE}
# Modifier les en-t√™tes des colonnes
tbl_summary_modified <- tbl_summary_example %>%
  modify_header(label~ "Nom de variables",stat_1 ~ "**Femmes**",  
                # Personnaliser l'en-t√™te de la col des var,
                #de la 1ere colonne des statistiques
    stat_2 ~ "**Hommes**"  # pour la 2e
    )

# Afficher le tableau modifi√©
tbl_summary_modified
```

| Autres param√®tres | Description |
|---------|-------------|
| modify_footnote_header() | Met √† jour la note de bas de colonne dans l'en-t√™te|
| modify_footnote_body() | Met √† jour la note de bas de colonne dans le corps du tableau|
| modify_spanning_header() | Met √† jour les en-t√™tes englobants (spanning headers)|
| modify_caption() | Met √† jour la l√©gende du tableau (titre)|
| bold_labels() | Met en gras les √©tiquettes des variables|
| bold_levels() | Met en gras les niveaux des variables|
| italicize_labels() | Met en italique les √©tiquettes des variables|
| italicize_levels() | Met en italique les niveaux des variables|
| bold_p() | Met en gras les p-values significatives|


```{r chap1tabpersoall, echo=TRUE, eval=TRUE, include=TRUE}
# Cr√©er le tableau de synth√®se personnalis√©
tbl_summary_personalized <- dataset %>%
  tbl_summary(
    by = hmstat,
    include = c(hage, hhsize)  # S√©lection des variables
  ) %>%
  add_overall() %>%  # Ajouter une colonne avec les statistiques globales
  add_n() %>%  # Ajouter une colonne avec N (ou N manquants)
  modify_header(label ~ "**Variables d'interet**") %>%  # Modifier l'en-t√™te des variables
  modify_spanning_header(c("stat_1", "stat_2","stat_3", "stat_4" ,"stat_5", "stat_6", "stat_7") ~ "**Etat matrimonial**") %>%  # En-t√™tes englobants
  modify_caption("Tableau modifi√©. Personnalisation") %>%  # L√©gende
  bold_labels() %>%  # Mettre en gras les √©tiquettes des variables
  italicize_labels() 
# Afficher le tableau modifi√©
tbl_summary_personalized

```

- Combinaison des tableaux avec tbl_merge() et tbl_stack()

*Combinaison de tableaux avec tbl_merge()*

La fonction tbl_merge() permet de fusionner plusieurs tableaux en un seul en ajoutant des colonnes provenant de diff√©rents tableaux.

Dans cet exemple, nous allons combiner 2 tableaux en un seul tableau avec tbl_merge().

```{r chap1tablecombined, echo=TRUE, eval=TRUE}

tbl_1 <- dataset %>%
  tbl_summary(by = milieu, include = c(hage, hhsize))

tbl_2 <- dataset %>%
  tbl_summary(by = hgender, include = c(hage, hhsize))

# Fusionner les deux tableaux dans une liste
tbl_combined <- tbl_merge(
  list(tbl_1, tbl_2), 
  tab_spanner = c("Tableau 1 - Par milieu de r√©sidence", "Tableau 2 - Par sexe")
)%>%
modify_header(label~ "Nom de variables/Modalit√©s")

# Afficher le tableau fusionn√©
tbl_combined
```

*Combinaison de tableaux avec tbl_stack()*

La fonction tbl_stack() permet d'empiler plusieurs tableaux gtsummary verticalement. Cela signifie que les lignes des diff√©rents tableaux sont combin√©es en un seul tableau. Attention : les ent√™tes de colonnes doivent correspondre. Si ce n‚Äôest pas le cas,
seules les ent√™tes du premier tableau sont conserv√©es dans le tableau final

Dans cet exemple, nous allons empiler deux tableaux cr√©√©s avec tbl_summary().

```{r chap1tablestacked, echo=TRUE, eval=TRUE}
# Cr√©er deux tableaux de statistiques descriptives
tbl_1 <- dataset %>%
  tbl_summary(by = milieu, include = c(hage, hhsize))
tbl_2 <- dataset %>%
  tbl_summary(by = hgender, include = c(hage, hhsize))

# Empiler les deux tableaux verticalement
tbl_stacked <- tbl_stack(
  tbls = list(tbl_1, tbl_2),  # Passer les tableaux sous forme de liste
  group_header = c("Tableau 1 - Par milieu", "Tableau 2 - Par sexe")
) %>%
  modify_header(label ~ "Nom de variables")  # Appliquer apr√®s le stacking

# Afficher le tableau empil√©
tbl_stacked
```

## 4. Personnalisation de l'apparence avec les th√®mes gtsummary

Le package gtsummary offre plusieurs th√®mes int√©gr√©s pour personnaliser l'apparence des tableaux g√©n√©r√©s, permettant ainsi d'adapter l'affichage en fonction du contexte d'utilisation (publication acad√©mique, rapport professionnel, etc.). Ces th√®mes influencent l'aspect g√©n√©ral du tableau, comme l'espacement, la mise en forme des en-t√™tes et des colonnes, ainsi que l'agencement des lignes et des bordures.

### a. theme_gtsummary_journal()
Ce th√®me permet de suivre le style de publication de revues acad√©miques, avec des options pour choisir parmi plusieurs journaux :

- "jama" (Journal of the American Medical Association)

- "lancet" (The Lancet)

- "nejm" (The New England Journal of Medicine)

- "qjecon" (The Quarterly Journal of Economics)

Exemple d'utilisation :

```{r, echo=TRUE, eval=TRUE, include=TRUE}
set_gtsummary_theme(theme_gtsummary_journal("qjecon"))  # Appliquer le th√®me 
dataset |> tbl_summary(include = c(hage, hmstat))%>%
  modify_header(label ~ "Nom de variables") 
```

### b. theme_gtsummary_compact()
Ce th√®me rend les tableaux plus compacts en r√©duisant la taille de la police et l'espacement des cellules, id√©al pour les rapports plus condens√©s.

Exemple d'utilisation :

```{r, echo=TRUE, eval=TRUE, include=TRUE}
set_gtsummary_theme(theme_gtsummary_compact())  # Appliquer le th√®me 'compact'
dataset |> tbl_summary(include = c(hage, hmstat))%>%
  modify_header(label ~ "Nom de variables") 
```

###  b. Autres th√®mes

Th√®me | Description | Script d'exemple
|---------|-------------|-------------|
theme_gtsummary_printer() | Permet de d√©finir le moteur de rendu des tableaux, en choisissant parmi plusieurs options comme gt, kable, flextable, etc. | theme_gtsummary_printer(print_engine = 'flextable', set_theme = TRUE)
theme_gtsummary_language() | Permet de d√©finir la langue des tableaux g√©n√©r√©s, avec des traductions disponibles pour plusieurs langues, y compris le fran√ßais, l'anglais, l'espagnol, etc. | theme_gtsummary_language(language = 'fr', set_theme = TRUE)
theme_gtsummary_continuous2() | Modifie la pr√©sentation des variables continues dans tbl_summary() pour afficher des statistiques comme la m√©diane et l'intervalle interquartile par d√©faut. | theme_gtsummary_continuous2(set_theme = TRUE)
theme_gtsummary_mean_sd() | D√©finit les statistiques par d√©faut pour les variables continues sur la moyenne et l'√©cart-type. | theme_gtsummary_mean_sd(set_theme = TRUE)
theme_gtsummary_eda() | Ce th√®me est con√ßu pour l'exploration des donn√©es (EDA) et affiche des statistiques suppl√©mentaires comme la m√©diane, l'IQ, la moyenne, l'√©cart-type et la plage. | theme_gtsummary_eda(set_theme = TRUE)

### Remarque :

- set_theme = TRUE : Applique le th√®me de mani√®re permanente.

- set_theme = FALSE : Retourne les √©l√©ments du th√®me sans l'appliquer.

## 5. Exportation des tableaux vers diff√©rents formats

### a. Exportation au format Word (flextable)

```{r chap1exportword, warning=FALSE}
# Exportation en format flextable (pour Word)
library(flextable) 
tbl_summary_flex <- tbl_summary_overall %>%
  modify_header(label ~ "Nom de variables") %>%
  as_flex_table() %>%
  autofit()  # Ajuster automatiquement la largeur des colonnes

# Affichage du tableau flextable
tbl_summary_flex

# Pour sauvegarder en Word (d√©commenter pour utiliser)
library(officer)
save_as_docx(tbl_summary_flex, path = "./tableaux_exportes/tableau_export√©_chap1.docx")
#flextable::save_as_html(resultats_flex, path = "./tableaux_exportes/tableau_export√©_chap1.html") # HTML
message("Le fichier 'tableau_export√©_chap1.docx' a √©t√© sauvegard√© avec succ√®s !")
```

### b. Exportation au format HTML (gt)

```{r chap1exporthtml, warning=FALSE}
# Exportation en format gt (pour HTML)
library(gt)
tbl_summary_gt <- tbl_summary_overall %>%
  modify_header(label ~ "Nom de variables") %>%
  as_gt() %>%
  tab_header(
    title = "Statistiques descriptives de l'EHCVM 2021",
    subtitle = "Avec nos variables d'int√©ret"
  ) %>%
  tab_options(
    heading.background.color = "#4E79A7",
    heading.title.font.size = 18,
    heading.subtitle.font.size = 14,
    column_labels.background.color = "#A0CBE8"
  )

# Affichage du tableau gt
tbl_summary_gt

# Pour sauvegarder en HTML (d√©commenter pour utiliser)
gt::gtsave(tbl_summary_gt, filename = "./tableaux_exportes/tableau_export√©_chap1.html")
message("Le fichier 'tableau_export√©_chap1.html' a √©t√© sauvegard√© avec succ√®s !")
```



<!---------------------------------------FIN DE SCRIPT - Chapitre 1-------------------------------------------->

